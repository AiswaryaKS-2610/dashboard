---
- name: Setup Docker and deploy container (Amazon Linux 2)
  hosts: webserver
  become: yes
  vars:
    app_user: ec2-user
    app_dir: /home/ec2-user/web

  pre_tasks:
    - name: Ensure python3 present (bootstrap)
      raw: |
        if ! command -v python3 >/dev/null 2>&1; then
          sudo yum -y install python3
        fi
      changed_when: false

    - name: Gather facts
      setup:

  tasks:
    - name: Install Docker (force yum backend)
      yum:
        name: docker
        state: present
        use_backend: yum

    - name: Enable and start Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add {{ app_user }} to docker group
      user:
        name: "{{ app_user }}"
        groups: docker
        append: yes

    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    - name: Copy web app files to server
      copy:
        src: ../web/
        dest: "{{ app_dir }}/"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"

    - name: Build docker image
      command: docker build -t dashboard-app "{{ app_dir }}"

    - name: Stop existing container if present
      command: docker stop dashboard-app
      register: stop_out
      failed_when: false
      changed_when: "'No such container' not in stop_out.stderr"

    - name: Remove existing container if present
      command: docker rm dashboard-app
      register: rm_out
      failed_when: false
      changed_when: "'No such container' not in rm_out.stderr"

    - name: Run container on port 80
      command: docker run -d -p 80:80 --restart unless-stopped --name dashboard-app dashboard-app
