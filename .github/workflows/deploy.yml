name: Deploy Dashboard Web to EC2

on:
  push:
    branches:
      - master  # Change to master if your repo uses master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Deploy web folder to EC2
      run: |
        # Remove old web files (adjust target folder)
        ssh -i ~/dashboard/terraform/keys/sample-key -o StrictHostKeyChecking=no ec2-user@13.60.48.237 \
          "rm -rf /home/ec2-user/dashboard-web/*"

        # Copy only the web folder
        scp -i ~/dashboard/terraform/keys/sample-key -o StrictHostKeyChecking=no -r ./web/* ec2-user@13.60.48.237:/home/ec2-user/dashboard-web/

        # Stop existing Docker container, remove it, and run Nginx serving web folder
        ssh -i ~/dashboard/terraform/keys/sample-key -o StrictHostKeyChecking=no ec2-user@13.60.48.237 \
          "sudo docker stop dashboard-web || true && sudo docker rm dashboard-web || true && \
           sudo docker run -d -p 80:80 -v /home/ec2-user/dashboard-web:/usr/share/nginx/html --name dashboard-web nginx"
