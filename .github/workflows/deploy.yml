name: Deploy Dashboard Web to EC2

on:
  push:
    branches:
      - master            # change to 'main' if your default branch is main
  workflow_dispatch: {}   # allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MY_EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 13.60.48.237 >> ~/.ssh/known_hosts

      - name: Deploy web folder to EC2 (free port 80 first)
        env:
          HOST: 13.60.48.237
          USER: ec2-user
          KEY: ~/.ssh/id_rsa
          REMOTE_DIR: /home/ec2-user/dashboard-web
        run: |
          set -euo pipefail

          # 1) Ensure target dir exists and is writable
          ssh -i "$KEY" -o StrictHostKeyChecking=no "$USER@$HOST" "mkdir -p '$REMOTE_DIR' && sudo chown -R $USER:$USER '$REMOTE_DIR'"

          # 2) Remove old web files, then copy the new web folder contents
          ssh -i "$KEY" -o StrictHostKeyChecking=no "$USER@$HOST" "rm -rf '$REMOTE_DIR'/*"
          scp -i "$KEY" -o StrictHostKeyChecking=no -r ./web/* "$USER@$HOST":"$REMOTE_DIR/"

          # 3) Reclaim port 80 from ANY container
          ssh -i "$KEY" -o StrictHostKeyChecking=no "$USER@$HOST" '
            ids=$(docker ps -q --filter "publish=80" || true)
            if [ -n "$ids" ]; then
              docker stop $ids >/dev/null 2>&1 || true
              docker rm   $ids >/dev/null 2>&1 || true
            fi
            docker stop dashboard-web  >/dev/null 2>&1 || true
            docker rm   dashboard-web  >/dev/null 2>&1 || true
            docker stop dashboard-app  >/dev/null 2>&1 || true
            docker rm   dashboard-app  >/dev/null 2>&1 || true
            if systemctl is-active --quiet nginx; then sudo systemctl stop nginx && sudo systemctl disable nginx; fi
            if systemctl is-active --quiet httpd; then sudo systemctl stop httpd && sudo systemctl disable httpd; fi
          '

          # 4) Start nginx serving the folder on port 80
          ssh -i "$KEY" -o StrictHostKeyChecking=no "$USER@$HOST" '
            docker pull nginx:alpine >/dev/null
            docker run -d --restart unless-stopped \
              -p 80:80 \
              -v "'"$REMOTE_DIR"'":/usr/share/nginx/html \
              --name dashboard-web \
              nginx:alpine
            docker ps --format "table {{.Names}}\t{{.Ports}}"
            sudo ss -ltnp | grep ":80" || true
          '

      - name: Verify site is up (HTTP 200/301/302 expected)
        env:
          HOST: 13.60.48.237
        run: |
          set -e
          curl -I --retry 6 --retry-delay 5 "http://$HOST"
